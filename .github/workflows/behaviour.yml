name: Behaviour Tests
on: [push]

env:
  PLATFORMSH_CLI_TOKEN: ${{ secrets.PLATFORMSH_CLI_TOKEN }}

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: gdate, dom, filter, gd, hash, json, pcre, PDO, session, SimpleXML, SPL, tokenizer, xml

      - name: Composer Install
        run: |
          composer --no-interaction --no-progress --optimize-autoloader install

      # Install Psh CLI.
      - name: Install Psh CLI
        run: curl -sS https://platform.sh/cli/installer | php

      # If you need to connect to database.
      - name: Load certificate
        run: ~/.platformsh/bin/platform ssh-cert:load -y -vvv

      - name: Add Psh to trusted keys
        run: |
          ssh-keyscan ssh.uk-1.platform.sh >> ~/.ssh/known_hosts
          ssh-keyscan git.uk-1.platform.sh >> ~/.ssh/known_hosts

      # Non-database Psh commands.
      - name: Spin up environment
        run: ~/.platformsh/bin/platform environment:activate --project=nlw7xhb3fyt7y -e ${GITHUB_REF#refs/heads/} --yes

      - name: connect to psh PR db
        run: |
          nohup platform tunnel:single --project=nlw7xhb3fyt7y --environment=${GITHUB_REF#refs/heads/} --port=30123 --relationship=database --yes & > phpd.log 2>&1 &

      - name: Start Drupal using remote db
        run: |
          cp ./.github/snippets/settings.local.php ./web/sites/default/settings.local.php
          curl http://localhost/user/login

      # Finally, run the tests.
      - name: Run Behat tests
        run: |
          ./vendor/bin/behat --colors

      - name: Tear it all down
        run: |
          platform tunnel:close   --project=nlw7xhb3fyt7y --environment=${GITHUB_REF#refs/heads/} --yes
